volumes:
  web-root:

services:
  web:
    image: trompa-align-mdw
    build:
      context: .
      dockerfile: Dockerfile
      target: production
      args:
        CLARA_BRANCH: main
    platform: linux/amd64
    env_file: mdw-environment
    restart: always
    ports:
      - "${WEB_HOST:-127.0.0.1}:${WEB_PORT:-8000}:8000"
    volumes:
      - web-root:/web-root

  redis:
    image: "redis:alpine"

  celery:
    image: trompa-align-mdw
    restart: always
    env_file: mdw-environment
    command:
      - uv
      - run
      - celery
      - -A
      - trompaalign.celery
      - worker
      - --concurrency
      - "${CELERY_WORKERS:-4}"

  celery-beat:
    image: trompa-align-mdw
    restart: always
    env_file: mdw-environment
    command:
      - uv
      - run
      - celery
      - -A
      - trompaalign.celery
      - beat

  db:
    image: postgres:18
    restart: always
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-example}
      POSTGRES_DB: ${POSTGRES_DB:-solid_oidc}
    volumes:
      - ./pgdata:/var/lib/postgresql
